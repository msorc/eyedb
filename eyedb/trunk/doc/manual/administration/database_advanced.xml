<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN" "http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd"
[
<!ENTITY eyedb "EyeDB">
<!ENTITY eyedbadmin "<command>eyedbadmin</command>">
]
>

<book>
  <title>EyeDB Administration Guide</title>

  <chapter id="database_advanced">
    <title>Database advanced administration</title>
    
    <para>
      This chapter explains &eyedb; databases advanced administration, namely the <emphasis>datafiles</emphasis> and <emphasis>dataspaces</emphasis> concepts that allow to create multi-volumes large &eyedb; databases.
    </para>

    <para>
      The first section describes &eyedb; databases architecture; the following sections deal with datafiles and dataspaces management commands.
    </para>

    <section>
      <title>&eyedb; databases architecture</title>

      <para>
	&eyedb; databases organisation is based on two concepts:
	<itemizedlist>
	  <listitem><para><emphasis>dataspaces</emphasis>: logical organization units for organizing where classes, objects, indexes...  will be located</para></listitem>
	  <listitem><para><emphasis>datafiles</emphasis>: physical files where data are stored</para></listitem>
	</itemizedlist>
      </para>

      <para>
	A database is composed of several dataspaces (at least one). When creating a database with no options, a dataspace named DEFAULT is automaticaly created.
      </para>

      <para>
	A datafile is always associated to a <emphasis>single</emphasis> dataspace, whilst a dataspace can contain several datafiles (up to 32 datafiles currently). When creating a database with no options, a datafile named DEFAULT, whose filename is &lt;&lt;database_name&gt;&gt;.dat and size is 2 Gb, is automaticaly created; this datafile is associated with the default dataspace.
      </para>

      <para>
	After database creation, new datafiles and dataspaces can be added at any time using the commands described in this section. Datafiles can be resized, moved, deleted and updated. Dataspaces can be deleted, renamed and updated.
      </para>

    </section>

    <section>
      <title>Managing datafiles</title>

      <para>
	This section describes how to manage datafiles: create, list and delete datafiles, renaming, moving, resizing and defragmenting datafiles.
      </para>

      <para>
	A datafile is identified by:
	<itemizedlist>
	  <listitem><para>an id (a number)</para></listitem>
	  <listitem><para>a name, that can be used in place of the id to identify the datafile</para></listitem>
	  <listitem><para>a file name, that is the operating system file name</para></listitem>
	</itemizedlist>
      </para>

      <note>
	<title>Datafile name and file name</title>
	<para id="note-datafile-name" xreflabel="Note">
	  The datafile name and its file name are two different things: the file name is simply the operating system file name, as in <filename>/var/tmp/foo.dat</filename> and the name is an identifier known by &eyedb; that can be used to identify the datafile as in <varname>FOO</varname>.
	</para>
      </note>

      <section>
	<title>Creating, listing and deleting datafiles</title>

	<para>
	  Creating a datafile is done using the &eyedbadmin; command:
	  <cmdsynopsis>
	    &eyedbadmin;
	    <command>datafile create</command>
	    <arg choice="opt">options</arg>
	    <arg choice="req"><replaceable>database</replaceable></arg>
	    <arg choice="req"><replaceable>datafile</replaceable></arg>
	  </cmdsynopsis>
	</para>

	<para>
	  Options are:
	  <itemizedlist>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="plain">--filedir=<replaceable>directory</replaceable></arg>
		</cmdsynopsis>
		datafile directory
	      </para>
	    </listitem>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="plain">--name=<replaceable>name</replaceable></arg>
		</cmdsynopsis>
		datafile name (see <xref linkend="note-datafile-name"/>)
	      </para>
	    </listitem>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="plain">--size=<replaceable>size</replaceable></arg>
		</cmdsynopsis>
		datafile size in Mbytes
	      </para>
	    </listitem>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="plain">--slotsize=<replaceable>slotsize</replaceable></arg>
		</cmdsynopsis>
		the allocation slot size in bytes
	      </para>
	    </listitem>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="plain">--physical</arg>
		</cmdsynopsis>
		to specify that this datafile will contain physical Oids (see <xref linkend="database_tuning"/>)
	      </para>
	    </listitem>
	  </itemizedlist>
	</para>

	<para>
	  Command arguments are:
	  <itemizedlist>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="req"><replaceable>database</replaceable></arg>
		</cmdsynopsis>
		the database to which the datafile will be attached
	      </para>
	    </listitem>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="req"><replaceable>datafile</replaceable></arg>
		</cmdsynopsis>
		the datafile name (.dat file name extension is recommended)
	      </para>
	    </listitem>
	  </itemizedlist>
	</para>

	<example id="eyedbadmin-datafile-create">
	  <title>&eyedbadmin; datafile create</title>
	  <screen>
## create a datafile
<userinput>eyedbadmin datafile create test3 data1.dat</userinput>
## create a datafile with a name
<userinput>eyedbadmin datafile create --name=DATA2 test3 data2.dat</userinput>
## create a datafile with a size of 30 Gb and a directory
<userinput>eyedbadmin datafile create --filedir=/var/tmp --size=30000 test3 data3.dat</userinput>
## list the database
<userinput>eyedbadmin database list --datafiles test3</userinput>
test3.dat
data1.dat
data2.dat
/var/tmp/data3.dat
	  </screen>
	</example>

	<para>
	  The list of the datafiles associated with a database can be obtained using the &eyedbadmin; command:
	  <cmdsynopsis>
	    &eyedbadmin;
	    <command>datafile list</command>
	    <arg choice="opt">options</arg>
	    <arg choice="req"><replaceable>database</replaceable></arg>
	    <arg choice="req" rep="repeat"><group><arg choice="req"><replaceable>datafile_id</replaceable></arg><arg choice="req"><replaceable>datafile_name</replaceable></arg></group></arg>
	  </cmdsynopsis>
	</para>

	<para>
	  Options are:
	  <itemizedlist>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="plain">--all</arg>
		</cmdsynopsis>
		list all informations about datafile
	      </para>
	    </listitem>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="plain">--stats</arg>
		</cmdsynopsis>
		list only statistics on datafile
	      </para>
	    </listitem>
	  </itemizedlist>
	</para>

	<para>
	  Command arguments are:
	  <itemizedlist>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="req"><replaceable>database</replaceable></arg>
		</cmdsynopsis>
		the database to which the datafile belongs
	      </para>
	    </listitem>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="req" rep="repeat"><group><arg choice="req"><replaceable>datafile_id</replaceable></arg><arg choice="req"><replaceable>datafile_name</replaceable></arg></group></arg>
		</cmdsynopsis>
		the datafiles to be listed, that can be specified either by its id or by its name
	      </para>
	    </listitem>
	  </itemizedlist>
	</para>

	<example id="eyedbadmin-datafile-list">
	  <title>&eyedbadmin; datafile list</title>
	  <screen>
## List
<userinput>eyedbadmin datafile list --all test3</userinput>
Datafile #0
  Name      DEFAULT
  Dataspace #0 DEFAULT
  File      test3.dat
  Maxsize   2147483648b, ~2097152Kb, ~2048Mb, ~2Gb
  Slotsize  16
  Oid Type  Logical

  Object Number        2561
  Total Busy Size      8439065b, ~8241Kb, ~8Mb
  Average Size         3295b, ~3Kb

... output deleted

Datafile #1
  Name      &lt;unnamed&gt;
  File      data1.dat
  Maxsize   2147483648b, ~2097152Kb, ~2048Mb, ~2Gb
  Slotsize  16
  Oid Type  Logical

... output deleted

Datafile #2
  Name      DATA2
  File      data2.dat
  Maxsize   2147483648b, ~2097152Kb, ~2048Mb, ~2Gb
  Slotsize  16
  Oid Type  Logical

... output deleted

Datafile #3
  Name      &lt;unnamed&gt;
  File      /var/tmp/data3.dat
  Maxsize   31457280000b, ~30720000Kb, ~30000Mb, ~29Gb
  Slotsize  16
  Oid Type  Logical

... output deleted
	  </screen>
	</example>


	<para>
	  Deleting a datafile is done using the &eyedbadmin; command:
	  <cmdsynopsis>
	    &eyedbadmin;
	    <command>datafile delete</command>
	    <arg choice="req"><group><arg choice="req"><replaceable>datafile_id</replaceable></arg><arg choice="req"><replaceable>datafile_name</replaceable></arg></group></arg>
	  </cmdsynopsis>
	</para>
	
	<para>
	  Command arguments are:
	  <itemizedlist>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="req"><replaceable>database</replaceable></arg>
		</cmdsynopsis>
		the database to which the datafile belongs
	      </para>
	    </listitem>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="req"><group><arg choice="req"><replaceable>datafile_id</replaceable></arg><arg choice="req"><replaceable>datafile_name</replaceable></arg></group></arg>
		</cmdsynopsis>
		the datafile to be deleted, that can be specified either by its id or by its name
	      </para>
	    </listitem>
	  </itemizedlist>
	</para>

	<example id="eyedbadmin-datafile-delete">
	  <title>&eyedbadmin; datafile delete</title>
	  <screen>
## Delete datafile by id
<userinput>eyedbadmin datafile delete test3 1</userinput>
## Delete datafile by name
<userinput>eyedbadmin datafile delete test3 DATA2</userinput>
## List
<userinput>eyedbadmin datafile list test3</userinput>
Datafile #0
  Name      DEFAULT
  Dataspace #0 DEFAULT
  File      test3.dat
  Maxsize   2147483648b, ~2097152Kb, ~2048Mb, ~2Gb
  Slotsize  16
  Oid Type  Logical

... output deleted

Datafile #3
  Name      &lt;unnamed&gt;
  File      /var/tmp/data3.dat
  Maxsize   31457280000b, ~30720000Kb, ~30000Mb, ~29Gb
  Slotsize  16
  Oid Type  Logical

... output deleted
	  </screen>
	</example>


      </section>

      <section id="eyedbadmin-datafile-rename-move">
	<title>Renaming and moving datafiles</title>

	<para>
	  A datafile has a name (see <xref linkend="note-datafile-name"/>); changing this name is done using the &eyedbadmin; command:
	  <cmdsynopsis>
	    &eyedbadmin;
	    <command>datafile rename</command>
	    <arg choice="req"><replaceable>database</replaceable></arg>
	    <arg choice="req"><group><arg choice="req"><replaceable>datafile_id</replaceable></arg><arg choice="req"><replaceable>datafile_name</replaceable></arg></group></arg>
	    <arg choice="req"><replaceable>new_name</replaceable></arg>
	  </cmdsynopsis>
	</para>

      <example id="eyedbadmin-datafile-rename">
	<title>&eyedbadmin; datafile rename</title>
	<screen>
## Rename datafile
<userinput>eyedbadmin datafile rename test3 3 DATA3</userinput>
## List
<userinput>eyedbadmin datafile list test3</userinput>
Datafile #0
  Name      DEFAULT
  Dataspace #0 DEFAULT
  File      test3.dat
  Maxsize   2147483648b, ~2097152Kb, ~2048Mb, ~2Gb
  Slotsize  16
  Oid Type  Logical

... output deleted

Datafile #3
  Name      DATA3
  File      /var/tmp/data3.dat
  Maxsize   31457280000b, ~30720000Kb, ~30000Mb, ~29Gb
  Slotsize  16
  Oid Type  Logical

... output deleted
	</screen>
      </example>

      <para>
	Moving a datafile is done using the &eyedbadmin; command:
	<cmdsynopsis>
	  &eyedbadmin;
	  <command>datafile move</command>
	  <arg choice="opt">options</arg>
	  <arg choice="req"><replaceable>database</replaceable></arg>
	  <arg choice="req"><group><arg choice="req"><replaceable>datafile_id</replaceable></arg><arg choice="req"><replaceable>datafile_name</replaceable></arg></group></arg>
	  <arg choice="req"><replaceable>new_datafile</replaceable></arg>
	</cmdsynopsis>
      </para>

	<para>
	  Options are:
	  <itemizedlist>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="plain">--filedir=<replaceable>directory</replaceable></arg>
		</cmdsynopsis>
		datafile directory
	      </para>
	    </listitem>
	  </itemizedlist>
	</para>

	<para>
	  Command arguments are:
	  <itemizedlist>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="req"><replaceable>database</replaceable></arg>
		</cmdsynopsis>
		the database to which the datafile belongs
	      </para>
	    </listitem>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="req"><group><arg choice="req"><replaceable>datafile_id</replaceable></arg><arg choice="req"><replaceable>datafile_name</replaceable></arg></group></arg>
		</cmdsynopsis>
		the datafile to be moved, that can be specified either by its id or by its name
	      </para>
	    </listitem>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="req"><replaceable>datafile</replaceable></arg>
		</cmdsynopsis>
		the new datafile file name (.dat file name extension is recommended)
	      </para>
	    </listitem>
	  </itemizedlist>
	</para>

	<example id="eyedbadmin-datafile-move">
	  <title>&eyedbadmin; datafile move</title>
	  <screen>
## Create destination directory
<userinput>mkdir /var/tmp/test3</userinput>
## Move datafile
<userinput>eyedbadmin datafile move --filedir=/var/tmp/test3 test3 DATA3 newdata3.dat</userinput>
## List
<userinput>eyedbadmin datafile list test3</userinput>
Datafile #0
  Name      DEFAULT
  Dataspace #0 DEFAULT
  File      test3.dat
  Maxsize   2147483648b, ~2097152Kb, ~2048Mb, ~2Gb
  Slotsize  16
  Oid Type  Logical

... output deleted

Datafile #3
  Name      DATA3
  File      /var/tmp/test3/newdata3.dat
  Maxsize   31457280000b, ~30720000Kb, ~30000Mb, ~29Gb
  Slotsize  16
  Oid Type  Logical

... output deleted
	  </screen>
	</example>

      </section>

      <section>
	<title>Resizing and defragmenting datafiles</title>

	<para>
	  Datafile size is set at creation time; once created, the size of a datafile can be changed using the &eyedbadmin; command:
	  <cmdsynopsis>
	    &eyedbadmin;
	    <command>datafile resize</command>
	  <arg choice="req"><replaceable>database</replaceable></arg>
	  <arg choice="req"><group><arg choice="req"><replaceable>datafile_id</replaceable></arg><arg choice="req"><replaceable>datafile_name</replaceable></arg></group></arg>
	  <arg choice="req"><replaceable>new_size</replaceable></arg>
	  </cmdsynopsis>
	</para>

	<para>
	  Command arguments are:
	  <itemizedlist>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="req"><replaceable>database</replaceable></arg>
		</cmdsynopsis>
		the database to which the datafile belongs
	      </para>
	    </listitem>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="req"><group><arg choice="req"><replaceable>datafile_id</replaceable></arg><arg choice="req"><replaceable>datafile_name</replaceable></arg></group></arg>
		</cmdsynopsis>
		the datafile to be resized, that can be specified either by its id or by its name
	      </para>
	    </listitem>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="req"><replaceable>new_size</replaceable></arg>
		</cmdsynopsis>
		the new datafile size, in Mbytes
	      </para>
	    </listitem>
	  </itemizedlist>
	</para>
	
	<example id="eyedbadmin-datafile-resize">
	  <title>&eyedbadmin; datafile resize</title>
	  <screen>
## List
<userinput>eyedbadmin datafile list test3 DATA3</userinput>
Datafile #3
  Name      DATA3
  File      /var/tmp/test3/newdata3.dat
  Maxsize   31457280000b, ~30720000Kb, ~30000Mb, ~29Gb
  Slotsize  16
  Oid Type  Logical

... output deleted
## Set new size to 40Gb
<userinput>eyedbadmin datafile resize test3 DATA3 40000</userinput>
## List
<userinput>eyedbadmin datafile list test3 DATA3</userinput>
Datafile #3
  Name      DATA3
  File      /var/tmp/test3/newdata3.dat
  Maxsize   41943040000b, ~40960000Kb, ~40000Mb, ~39Gb
  Slotsize  16
  Oid Type  Logical

... output deleted
	  </screen>
	</example>

<!--
	<para>
	  Datafiles can become fragmented because of object deletion; the allocator used inside datafile is a bitmap allocator for better efficiency, but as a consequence there can be holes in the datafile that can impact performance. Defragmenting can be done using the &eyedbadmin; command:
	  <cmdsynopsis>
	    &eyedbadmin;
	    <command>datafile defragment</command>
	  <arg choice="req"><replaceable>database</replaceable></arg>
	  <arg choice="req"><group><arg choice="req"><replaceable>datafile_id</replaceable></arg><arg choice="req"><replaceable>datafile_name</replaceable></arg></group></arg>
	  </cmdsynopsis>
	</para>

	<para>
	  Command arguments are:
	  <itemizedlist>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="req"><replaceable>database</replaceable></arg>
		</cmdsynopsis>
		the database to which the datafile belongs
	      </para>
	    </listitem>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="req"><group><arg choice="req"><replaceable>datafile_id</replaceable></arg><arg choice="req"><replaceable>datafile_name</replaceable></arg></group></arg>
		</cmdsynopsis>
		the datafile to be defragmented, that can be specified either by its id or by its name
	      </para>
	    </listitem>
	  </itemizedlist>
	</para>
	
	<example id="eyedbadmin-datafile-defragment">
	  <title>&eyedbadmin; datafile defragment</title>
	  <screen>
...
	  </screen>
	</example>
-->

      </section>

    </section>

    <section>
      <title>Managing dataspaces</title>

      <section>
	<title>Creating, updating and deleting dataspaces</title>

	<example id="eyedbadmin-dataspace-create">
	  <title>&eyedbadmin; dataspace create</title>
	  <screen>
# creating a dataspace gathering those 4 datafiles
eyedbadmin dataspace create foo DSP1 1 2 3
	  </screen>
	</example>

      </section>

      <section>
	<title>Listing and renaming dataspaces</title>

	<para>
	</para>

      </section>

      <section>
	<title>Setting current dataspace and current datafile</title>

	<para>
	</para>

      </section>

    </section>

  </chapter>

<!--
;;; Local Variables: ***
;;; eval: (load-file "emacs-macro") ***
;;; End: ***
-->

</book>
