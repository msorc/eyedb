<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN" "http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd"
[
<!ENTITY eyedb "EyeDB">
<!ENTITY eyedbctl "<command>eyedbctl</command>">
]
>

<book>
  <title>EyeDB Administration Guide</title>

  <chapter id="server">
    <title>Server administration</title>

    <para>
      The first step in &eyedb; administration adresses the server administration: as all existing database management systems, &eyedb; adopts a client/server architecture to provide databases integrity and concurrent accesses. Every database operation requires that a server is up and running; this chapter explains how to start and stop the server, get its status and manage its configuration.
    </para>


    <section>
      <title>The &eyedbctl; command</title>

      <para>
	The &eyedb; server is started, stopped and examined using the &eyedbctl; command. This command is installed in <filename class="directory">/usr/sbin</filename> for standard &eyedb; installations.
      </para>

      <para>
	The &eyedbctl; command has the following syntax:
	<cmdsynopsis>
	  &eyedbctl;<arg choice="plain"><replaceable>command</replaceable></arg><arg choice="plain" rep="repeat">options</arg>
	</cmdsynopsis>
	where <cmdsynopsis><arg choice="plain"><replaceable>command</replaceable></arg></cmdsynopsis> is one of <command>start</command>, <command>stop</command> or <command>status</command>.
      </para>

      <para>
	The following options are the most usefull:
	<itemizedlist>
	  <listitem>
	    <para id="eyedbctl_listen" xreflabel="eyedbctl --listen option">
	      <cmdsynopsis>
		<arg choice="plain">
		  --listen=
		  <arg choice="plain" rep="repeat">
		    <group>
		      <arg choice="plain">
			<arg choice="opt"><replaceable>hostname:</replaceable></arg>
			<arg choice="plain"><replaceable>port</replaceable></arg>
		      </arg>
		      <arg choice="plain">
			<replaceable>unix socket name</replaceable>
		      </arg>
		    </group>
		    ,
		  </arg>
		</arg>
	      </cmdsynopsis>
	      specifies the port the server is listening on. This port can be either a TCP port, specified by a hostname (defaults to "localhost") and a TCP port number, or a Unix socket, specified by a file name.
	    </para>
	  </listitem>
	  <listitem>
	    <para>
	      <cmdsynopsis>
		<arg choice="plain">--access-file=<replaceable>file</replaceable></arg>
		</cmdsynopsis> specifies the server access file for network configuration (see <xref linkend="server_network_access_configuration"/>)
	    </para>
	  </listitem>
	  <listitem>
	    <para>
	      <cmdsynopsis>
		<arg choice="plain">--server-conf=<replaceable>file</replaceable></arg>
		</cmdsynopsis> specifies the server configuration file (see <xref linkend="server_configuration_file"/>)
	    </para>
	  </listitem>
	  <listitem>
	    <para>
	      <cmdsynopsis>
		<arg choice="plain">--nod</arg>
		</cmdsynopsis> no daemon mode, do not close file descriptors 0, 1 band 2
	    </para>
	  </listitem>
	</itemizedlist>
      </para>

    </section>


    <section>
      <title>Starting and stopping the server</title>

      <section>
	<title>Starting &eyedb; server</title>

	<para>
	  The &eyedb; server is started using the following command:
	  <cmdsynopsis>
	    &eyedbctl;<arg choice="plain">start</arg><arg choice="plain" rep="repeat"><replaceable>options</replaceable></arg>
	  </cmdsynopsis>	  
	</para>

	<example id="eyedbctl-start">
	  <title>&eyedbctl; start</title>
	  <screen><userinput>eyedbctl start</userinput>
Starting EyeDB Server
 Version      V2.8.8
 Compiled     Feb 14 2009 00:16:45
 Architecture i686-pc-linux-gnu
 Program Pid  19433
	  </screen>
	</example>

	<para>
	  By default, the &eyedb; server listens to incoming client connections on 2 ports:
	  <itemizedlist>
	    <listitem><para>a TCP/IP socket bound to port 6240</para></listitem>
	    <listitem><para>a Unix socket bound to file name <filename>/var/lib/eyedb/pipes/eyedbd</filename> for standard installation,  or <filename>PREFIX/var/lib/eyedb/pipes/eyedbd</filename> where <filename>PREFIX</filename> is the installation prefix that has been set during configuration</para></listitem>
	  </itemizedlist>
	</para>

	<para>
	  The listening ports can be set:
	  <itemizedlist>
	    <listitem><para>using &eyedbctl; command options --listen (see <xref linkend="eyedbctl_listen"/>)</para></listitem>
	    <listitem><para>using server configuration file (see <xref linkend="server_configuration_file"/>)</para></listitem>
	  </itemizedlist>
	</para>

	<example id="eyedbctl-start--listen">
	  <title>&eyedbctl; start with --listen option</title>
	  <screen><userinput>eyedbctl start --listen=localhost:10000,/var/tmp/eyedb-socket</userinput>
Starting EyeDB Server
 Version      V2.8.8
 Compiled     Feb 14 2009 00:16:45
 Architecture i686-pc-linux-gnu
 Program Pid  19560
	  </screen>
	</example>

      </section>

      <section>
	<title>Stopping &eyedb; server</title>

	<para>
	  The &eyedb; server is stopped using the following command:
	  <cmdsynopsis>
	    &eyedbctl;<arg choice="plain">stop</arg><arg choice="plain" rep="repeat"><replaceable>options</replaceable></arg>
	  </cmdsynopsis>	  
	</para>

	<example id="eyedbctl-stop">
	  <title>&eyedbctl; stop</title>
	  <screen><userinput>eyedbctl stop</userinput>
Killing EyeDB Server Pid 19433
	  </screen>
	</example>

	<para>
	  If the server was started with the <command>--listen</command> option to set the listening port, the <emphasis>same</emphasis> option must be passed to &eyedbctl; when stopping the server.
	</para>

	<example id="eyedbctl-stop--listen">
	  <title>&eyedbctl; stop with --listen option</title>
	  <screen>
<userinput>eyedbctl stop</userinput>
No EyeDB Server is running on localhost:6240
<userinput>eyedbctl stop --listen=localhost:10000,/var/tmp/eyedb-socket</userinput>
Killing EyeDB Server Pid 19560
	  </screen>
	</example>

      </section>

    </section>

    <section>
      <title>Getting server information</title>

      <para>
	Once &eyedb; server has been launched, information can be obtained on server status (server uptime, listening ports, clients...) using &eyedbctl;.
      </para>

      <para>
	Independently from server status, the &eyedb; server can be launched with logging option, that allows to trace precisely all server actions (client connections, transactions...).
      </para>

      <section>
	<title>Getting &eyedb; server status</title>

	<para>
	  The &eyedb; server status can be obtained using the following command:
	  <cmdsynopsis>
	    &eyedbctl;<arg choice="plain">status</arg><arg choice="plain" rep="repeat"><replaceable>options</replaceable></arg>
	  </cmdsynopsis>	  
	  This command will print on its standard output informations about the &eyedb; server currently running: server PID and user, version, listening ports and list of connected clients.
	</para>

	<example id="eyedbctl-status">
	  <title>&eyedbctl; status</title>
	  <screen>
<userinput>eyedbctl status</userinput>

EyeDB Server running since Thu Mar  5 16:08:45 2009

  Version       V2.8.8
  Date          Feb 14 2009 00:16:45
  Architecture  i686-pc-linux-gnu
  Program Pid   19433
  Running Under francois

  Listening on  localhost:6240
                localhost:/home/francois/projects/eyedb/install/var/lib/eyedb/pipes/eyedbd
  Datafile Directory /home/francois/projects/eyedb/install/var/lib/eyedb/db

  No Clients connected.
	  </screen>
	</example>


	<para>
	  Same as for stopping server, if the server was started with the <command>--listen</command> option to set the listening port, the <emphasis>same</emphasis> option must be passed to &eyedbctl; when getting server status.
	</para>

	<example id="eyedbctl-status--listen">
	  <title>&eyedbctl; status with --listen option</title>
	  <screen>
<userinput>eyedbctl status --listen=localhost:10000,/var/tmp/eyedb-socket</userinput>
EyeDB Server running since Thu Mar  5 16:09:07 2009

  Version       V2.8.8
  Date          Feb 14 2009 00:16:45
  Architecture  i686-pc-linux-gnu
  Program Pid   19560
  Running Under francois

  Listening on  localhost:10000
                localhost:/var/tmp/eyedb-socket
  Datafile Directory /home/francois/projects/eyedb/install/var/lib/eyedb/db

  No Clients connected.
	  </screen>
	</example>

	<para>
	  If clients are connected, the server status will show the list of connected clients, giving for each client a list of open databases.
	</para>

	<example id="eyedb-status-clients">
	  <title>&eyedbctl; status with connected clients</title>
	  <screen>
<userinput>eyedbctl status</userinput>
EyeDB Server running since Thu Mar  5 16:46:55 2009

  Version       V2.8.8
  Date          Feb 14 2009 00:16:45
  Architecture  i686-pc-linux-gnu
  Program Pid   20332
  Running Under francois

  Listening on  localhost:6240
                localhost:/home/francois/projects/eyedb/install/var/lib/eyedb/pipes/eyedbd
  Datafile Directory /home/francois/projects/eyedb/install/var/lib/eyedb/db

  1 Client connected

Client #0
  Connected on Thu Mar  5 16:53:01 2009
  Host:Port    localhost:/home/francois/projects/eyedb/install/var/lib/eyedb/pipes/eyedb
  User Name    francois
  Program Name eyedboql
  Client Pid   20377
  EyeDB Server Pid 20378
  Open Databases 'EYEDBDBM' [mode=sread/local]
                   'EYEDBDBM' [mode=sread/local]
                   'EYEDBDBM' [mode=sread/local]
                   'test' [mode=sread] [userauth=francois]
	  </screen>
	</example>

      </section>

      <section>
	<title>Configuring &eyedb; server logging</title>

	<para>
	  The &eyedb; server can log its activities with a fine grain control over what is logged (client connections, transactions, index...). This logging can be done into a file or into a special file such as <filename>/dev/stderr</filename>. 
	</para>

	<para>
	  The following options of &eyedbctl; are used to control server logging:
	  <itemizedlist>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="plain">--logdev=<replaceable>logfile</replaceable></arg>
		</cmdsynopsis>
		specifies output log file (can be either a plain file, or a special file like <filename>/dev/stderr</filename>
	      </para>
	    </listitem>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="plain">--logmask=<replaceable>mask</replaceable></arg>
		</cmdsynopsis>
		specifies log mask (see <xref linkend="eyedbctl_log_mask"/> for log mask values)
	      </para>
	    </listitem>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="plain">--logdate=<group><arg choice="plain">on</arg><arg choice="plain">off</arg></group></arg>
		</cmdsynopsis>
		controls display of date in output log
	      </para>
	    </listitem>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="plain">--logtimer=<group><arg choice="plain">on</arg><arg choice="plain">off</arg></group></arg>
		</cmdsynopsis> 
		controls display of time in output log
	      </para>
	    </listitem>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="plain">--logpid=<group><arg choice="plain">on</arg><arg choice="plain">off</arg></group></arg>
		</cmdsynopsis>
		controls display of process pid in output log
	      </para>
	    </listitem>
	    <listitem>
	      <para>
		<cmdsynopsis>
		  <arg choice="plain">--logprog=<group><arg choice="plain">on</arg><arg choice="plain">off</arg></group></arg>
		</cmdsynopsis>
		controls display of program name in output log
	      </para>
	    </listitem>
	  </itemizedlist>
	</para>

	<para id="eyedbctl_log_mask" xreflabel="log mask values">
	  Log mask is either an hexadecimal number or a combination of symbols prefixed by + (to enable the corresponding log) or - (to disable the corresponding log). The list of allowed symbols can be obtained by running <command>eyedbctl start --logmask=help</command>. For instance, specifying <command>--logmask=+server+connection</command> will log all server and connection events.
	</para>

	<para>
	  <xref linkend="log-mask-example"/> shows an example of launching &eyedb; server with logging enabled, running an &eyedb; command (here: <command>eyedbadmin</command>) and examining the log file (here <filename>/var/tmp/eyedbd.log</filename>) with the <command>tail</command>.
	</para>

	<example id="log-mask-example">
	  <title>Launching &eyedb; server with logging enabled</title>
	  <screen>
<userinput>eyedbctl start --logdev=/var/tmp/eyedbd.log --logdate=on --logpid=on --logprog=on --logmask=+server+connection</userinput>
Starting EyeDB Server
 Version      V2.8.8
 Compiled     Feb 14 2009 00:16:45
 Architecture i686-pc-linux-gnu
 Program Pid  7484
<userinput>eyedbadmin database list</userinput>
...
<userinput>tail -f /var/tmp/eyedbd.log </userinput>
Thu Mar  5 19:19:04 2009 [thread 7484#-1216465216] eyedbd : rpc_multiConnManage 0
Thu Mar  5 19:19:04 2009 [thread 7484#-1216465216] eyedbd : rpc_multiConnManage 1
Thu Mar  5 19:19:04 2009 [thread 7484#-1216465216] eyedbd : rpc_multiConnManage 2
Thu Mar  5 19:19:04 2009 [thread 7484#-1216465216] eyedbd : new connection : fd = 0, fd = 1, fd = 2
Thu Mar  5 19:19:04 2009 [thread 7522#-1216465216] eyedbd : rpc_makeThread which=0, fd=0
CONN Thu Mar  5 19:19:04 2009 [thread 7522#-1225118832] eyedbd : new thread -1225118832 [fd = 0, which=0], stack = 0xb6fa239c
CONN Thu Mar  5 19:19:04 2009 [thread 7522#-1225118832] eyedbd : connected host='localhost:/home/francois/projects/eyedb/install/var/lib/eyedb/pipes/eyedbd', username='francois', progname='eyedbadmin', pid=7521
Thu Mar  5 19:19:04 2009 [thread 7522#-1216465216] eyedbd : rpc_makeThread which=1, fd=1
CONN Thu Mar  5 19:19:04 2009 [thread 7522#-1564058736] eyedbd : new thread -1564058736 [fd = 1, which=1], stack = 0xa2c6539c
Thu Mar  5 19:19:04 2009 [thread 7522#-1216465216] eyedbd : rpc_makeThread which=2, fd=2
CONN Thu Mar  5 19:19:04 2009 [thread 7522#-1580647536] eyedbd : new thread -1580647536 [fd = 2, which=2], stack = 0xa1c9339c
Thu Mar  5 19:19:04 2009 [thread 7522#-1564058736] eyedbd : -1564058736 thread EXIT
Thu Mar  5 19:19:04 2009 [thread 7522#-1564058736] eyedbd : rpc_garbClientInfo(which = 0, fd = 1, ci = 0x9ce8100)
Thu Mar  5 19:19:04 2009 [thread 7522#-1564058736] eyedbd : refcnt = 3, fd_cnt = 3
Thu Mar  5 19:19:04 2009 [thread 7522#-1564058736] eyedbd : close connection fd=1
...
	  </screen>
	</example>


      </section>

    </section>

    <section>
      <title>Server configuration</title>

      <para>
	The &eyedb; server can be configured in several ways: 
	<itemizedlist>
	  <listitem><para>using &eyedbctl; options</para></listitem>
	  <listitem><para>using server configuration file</para></listitem>
	  <listitem><para>using environment variables</para></listitem>
	</itemizedlist>
      </para>

      <para>
	These two latter configuration methods are described in next sections.
      </para>

      <section id="server_configuration_file">
	<title>Server configuration file</title>

	<para>

	</para>

      </section>

      <section>
	<title>Server configuration variables</title>

	<para>
	</para>

      </section>

      <section>
	<title>Environment variables</title>

	<para>
	</para>

      </section>

    </section>

    <section id="server_network_access_configuration">
      <title>Network access server configuration</title>

      <para>
      </para>

    </section>

  </chapter>

</book>
