#!/bin/bash
EYEDB_BINDIR=@EYEDB_BINDIR@
EYEDB_SBINDIR=@EYEDB_SBINDIR@
EYEDB_JAR=@EYEDB_JAR@
POLEPOS_DIR=@POLEPOS_DIR@
JAVA=@JAVA@
srcdir=@srcdir@
top_srcdir=@top_srcdir@
top_builddir=@top_builddir@
EYEDB_BENCHMARK_JAR=${top_builddir}/src/java/eyedb-benchmark.jar
PROPERTIES=${srcdir}/eyedb.properties

DATABASE=`grep database $PROPERTIES | awk -F = '{print $2}'`
PORT=`grep tcp_port $PROPERTIES | awk -F = '{print $2}'`
SCHEMA=${top_srcdir}/src/java/org/eyedb/benchmark/polepos/teams/eyedb/data/data.odl

start_server() {
    $EYEDB_SBINDIR/eyedbctl start --listen=$PORT --nod
}

delete_db() {
    if $EYEDB_BINDIR/eyedbadmin database list --port=$PORT $DATABASE 2>&1 | grep -v 'not found' > /dev/null ; then
	$EYEDB_BINDIR/eyedbadmin database delete --port=$PORT $DATABASE
    fi
}

create_db() {
    if $EYEDB_BINDIR/eyedbadmin database list --port=$PORT $DATABASE 2>&1 | grep -v 'not found' > /dev/null ; then
	:
    else
	$EYEDB_BINDIR/eyedbadmin database create --port=$PORT $DATABASE
	$EYEDB_BINDIR/eyedbadmin database defaccess --port=$PORT $DATABASE rw
	$EYEDB_BINDIR/eyedbodl --port=$PORT --update --database=$DATABASE $SCHEMA
    fi
}

build_classpath() {
    CLASSPATH=""
    CLASSPATH=$CLASSPATH:$POLEPOS_DIR/lib/graph/jfreechart-1.0.0-pre2.jar
    CLASSPATH=$CLASSPATH:$POLEPOS_DIR/lib/graph/jcommon-1.0.0-pre2.jar
    CLASSPATH=$CLASSPATH:$POLEPOS_DIR/lib/graph/itext-1.2.jar
    CLASSPATH=$CLASSPATH:$POLEPOS_DIR/lib/graph/velocity-dep-1.4.jar
    CLASSPATH=$CLASSPATH:$EYEDB_BENCHMARK_JAR:$EYEDB_JAR:$POLEPOS_DIR/bin

}

run_benchmark() {
    CLASSPATH=$CLASSPATH $JAVA org.eyedb.benchmark.polepos.RunSeasonEyeDB
}

stop_server() {
    $EYEDB_SBINDIR/eyedbctl stop --listen=$PORT 
}

stop_server
set -e
start_server
delete_db
create_db
build_classpath
run_benchmark
stop_server

