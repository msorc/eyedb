#!/bin/bash
srcdir=@srcdir@
top_srcdir=@top_srcdir@
top_builddir=@top_builddir@
EYEDB_BINDIR=@EYEDB_BINDIR@
EYEDB_SBINDIR=@EYEDB_SBINDIR@
EYEDB_JAR=@EYEDB_JAR@
POLEPOS_DIR=@POLEPOS_DIR@
JAVA=@JAVA@

EYEDB_BENCHMARK_JAR=${top_builddir}/src/java/eyedb-benchmark.jar
PROPERTIES=${srcdir}/eyedb.properties

DATABASE=`grep database $PROPERTIES | awk -F = '{print $2}'`
PORT=`grep tcp_port $PROPERTIES | awk -F = '{print $2}'`
SCHEMA=${top_srcdir}/src/java/org/eyedb/benchmark/polepos/teams/eyedb/data/data.odl

run_benchmark() {
    CLASSPATH=$CLASSPATH:$EYEDB_JAR
    if test $# -eq 1 ; then
	BENCH=$1
	CLASSPATH=$CLASSPATH $JAVA -Dpolepos.circuits=$BENCH org.eyedb.benchmark.polepos.RunSeasonEyeDB
    else
	CLASSPATH=$CLASSPATH $JAVA org.eyedb.benchmark.polepos.RunSeasonEyeDB
    fi
}

. $top_builddir/run/utils/common/functions
. $top_builddir/run/utils/polepos/functions
. $top_builddir/run/utils/eyedb/functions

read_property $PROPERTIES "DATABASE"
read_property $PROPERTIES "PORT"
stop_server $PORT
set -e
start_server $PORT
delete_db $PORT $DATABASE
create_db $PORT $DATABASE $SCHEMA
resize_shm $PORT $DATABASE
build_classpath
run_benchmark $*
stop_server $PORT

